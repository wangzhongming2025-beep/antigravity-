<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿é•¿ä½œæˆ˜æŒ‡æŒ¥å®¤ - å…¨å‘˜ç›‘æ§å¤§å±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e4e4e7;
        }

        .glass-panel {
            background: rgba(24, 24, 27, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .success-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .fail-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }
    </style>
</head>

<body class="min-h-screen p-6">

    <div class="max-w-6xl mx-auto">
        <!-- Dashboard Header -->
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">è€ç‹ç‰¹è®­è¥ Â· <span
                        class="text-cyan-400">ä½œæˆ˜æŒ‡æŒ¥å®¤</span></h1>
                <p class="text-zinc-500 text-sm mt-1">å®æ—¶ç›‘æ§å­¦å‘˜è®­ç»ƒåŠ¨æ€ä¸è§†è§‰æ¿€æ´»è¿›åº¦</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-xs text-zinc-500 uppercase font-mono">Current Status</p>
                    <p class="text-sm font-bold text-green-400">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</p>
                </div>
                <button onclick="refreshData()"
                    class="p-3 bg-zinc-900 rounded-xl hover:bg-zinc-800 transition-colors border border-zinc-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                        <path d="M21 3v5h-5" />
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                        <path d="M3 21v-5h5" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-panel p-6 rounded-3xl">
                <p class="text-zinc-500 text-xs mb-1 uppercase font-mono tracking-widest">åœ¨å†Œå­¦å‘˜</p>
                <p class="text-3xl font-black text-white" id="total-trainees">--</p>
            </div>
            <div class="glass-panel p-6 rounded-3xl">
                <p class="text-zinc-500 text-xs mb-1 uppercase font-mono tracking-widest">ä»Šæ—¥æ‰“å¡</p>
                <p class="text-3xl font-black text-cyan-400" id="today-active">--</p>
            </div>
            <div class="glass-panel p-6 rounded-3xl">
                <p class="text-zinc-500 text-xs mb-1 uppercase font-mono tracking-widest">æ´»è·ƒæ·±åº¦</p>
                <p class="text-3xl font-black text-purple-400">89%</p>
            </div>
            <div class="glass-panel p-6 rounded-3xl">
                <p class="text-zinc-500 text-xs mb-1 uppercase font-mono tracking-widest">å¹³å‡è§†æœé€Ÿåº¦</p>
                <p class="text-3xl font-black text-emerald-400">18.4s</p>
            </div>
        </div>

        <!-- Main Monitor Table -->
        <div class="glass-panel rounded-[32px] overflow-hidden">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h2 class="text-lg font-bold">å…¨å‘˜å®æ—¶ç›‘æµ‹å¤§å±</h2>
                <div class="flex items-center gap-2 text-xs text-zinc-500">
                    <span class="flex items-center gap-1">
                        <div class="success-dot"></div> ä¼˜ç§€
                    </span>
                    <span class="flex items-center gap-1 ml-4">
                        <div class="fail-dot"></div> æ‰é˜Ÿ
                    </span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-zinc-900/50 text-zinc-500 text-[10px] uppercase tracking-widest font-mono">
                            <th class="px-6 py-4">å­¦å‘˜ç¼–å·</th>
                            <th class="px-6 py-4">å§“å</th>
                            <th class="px-6 py-4">ä»Šæ—¥ Gabor</th>
                            <th class="px-6 py-4">ä»Šæ—¥ä¸“æ³¨åŠ›</th>
                            <th class="px-6 py-4">è¿ç»­æ‰“å¡</th>
                            <th class="px-6 py-4">è·èµæ•°</th>
                            <th class="px-6 py-4">çŠ¶æ€</th>
                            <th class="px-6 py-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="monitor-tbody" class="divide-y divide-white/5">
                        <!-- Loaded by JS -->
                        <tr>
                            <td colspan="8" class="px-6 py-20 text-center text-zinc-600">æ­£åœ¨åŒæ­¥æˆ˜åŒºæ•°æ®...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="reward-toast"
        class="fixed top-6 right-6 z-50 transform translate-x-full opacity-0 transition-all duration-500 pointer-events-none">
        <div class="glass-panel px-6 py-4 rounded-2xl flex items-center gap-3 shadow-2xl border-green-500/30 border">
            <div class="w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center text-2xl">ğŸ–ï¸</div>
            <div>
                <p class="text-white font-bold text-sm">è¡¨æ‰¬æˆåŠŸï¼</p>
                <p class="text-zinc-400 text-xs" id="reward-toast-msg">å·²è®°å½•å¥–åŠ±</p>
            </div>
        </div>
    </div>

    <!-- Script Area -->
    <script>
        const SUPABASE_URL = 'https://oqwqlrmqblguiikrsmjf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xd3Fscm1xYmxndWlpa3JzbWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzcwMDUsImV4cCI6MjA4MzcxMzAwNX0.JlVesN-orDXZa5skq_WmKcVTlLP_HKMq2GKWwfuMoTA';

        // Store all rewards for display
        let allRewards = {};

        // Show success toast
        function showRewardToast(traineeName) {
            const toast = document.getElementById('reward-toast');
            document.getElementById('reward-toast-msg').innerText = `${traineeName} +1 ğŸ‰`;
            toast.classList.remove('translate-x-full', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');

            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.classList.remove('translate-x-0', 'opacity-100');
            }, 3000);
        }

        // Give reward to a trainee
        async function giveReward(traineeId, traineeName) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'å‘é€ä¸­...';
            btn.disabled = true;

            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/training_logs`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trainee_id: traineeId,
                        project_name: 'reward',
                        score: '1',
                        duration: 0
                    })
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.message || 'å‘é€å¤±è´¥');
                }

                showRewardToast(traineeName);

                // Add confetti effect on the button
                btn.innerText = 'âœ… å·²è¡¨æ‰¬';
                btn.classList.add('text-green-400', 'border-green-500/50');

                // Refresh data after a short delay
                setTimeout(() => {
                    refreshData();
                }, 1000);

            } catch (e) {
                console.error('Reward failed:', e);
                alert('è¡¨æ‰¬å‘é€å¤±è´¥: ' + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function refreshData() {
            const tbody = document.getElementById('monitor-tbody');

            try {
                // 1. Fetch Trainees
                const tRes = await fetch(`${SUPABASE_URL}/rest/v1/trainees?select=*&order=trainee_id.asc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                const trainees = await tRes.json();

                if (trainees.error) throw new Error(`å­¦å‘˜è¡¨é”™è¯¯: ${trainees.error.message}`);
                if (!Array.isArray(trainees)) throw new Error('å­¦å‘˜è¡¨è¿”å›æ ¼å¼é”™è¯¯ (éæ•°ç»„)');
                document.getElementById('total-trainees').innerText = trainees.length;

                // 2. Fetch Today's Logs
                const today = new Date().toISOString().split('T')[0];
                const lRes = await fetch(`${SUPABASE_URL}/rest/v1/training_logs?created_at=gte.${today}&select=*`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                const logs = await lRes.json();
                if (logs.error) throw new Error(`è®°å½•è¡¨é”™è¯¯: ${logs.error.message}`);
                if (!Array.isArray(logs)) throw new Error('è®°å½•è¡¨è¿”å›æ ¼å¼é”™è¯¯ (éæ•°ç»„)');

                // 3. Fetch ALL reward records (not just today)
                const rRes = await fetch(`${SUPABASE_URL}/rest/v1/training_logs?project_name=eq.reward&select=trainee_id`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                const rewards = await rRes.json();

                // Count rewards per trainee
                allRewards = {};
                if (Array.isArray(rewards)) {
                    rewards.forEach(r => {
                        allRewards[r.trainee_id] = (allRewards[r.trainee_id] || 0) + 1;
                    });
                }

                // 4. Map logs to trainees
                tbody.innerHTML = '';
                let activeCount = 0;

                trainees.forEach(t => {
                    const tLogs = logs.filter(l => l.trainee_id === t.trainee_id && l.project_name !== 'reward');
                    const gaborLogs = tLogs.filter(l => l.project_name === 'gabor');
                    const schulteLogs = tLogs.filter(l => l.project_name.startsWith('schulte'));
                    const rewardCount = allRewards[t.trainee_id] || 0;

                    if (tLogs.length > 0) activeCount++;

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-white/5 transition-colors cursor-default';
                    row.innerHTML = `
                        <td class="px-6 py-6 font-mono font-bold text-zinc-400">${t.trainee_id}</td>
                        <td class="px-6 py-6 font-bold text-white">${t.name || 'ç‰¹ç­‰å­¦å‘˜'}</td>
                        <td class="px-6 py-6">
                            ${gaborLogs.length > 0
                            ? `<span class="text-green-400 text-xs font-bold">âœ… å·²ç»ƒ (${gaborLogs[0].score})</span>`
                            : `<span class="text-zinc-700 text-xs">âŒ æœªè®­ç»ƒ</span>`}
                        </td>
                        <td class="px-6 py-6">
                            ${schulteLogs.length > 0
                            ? `<span class="text-green-400 text-xs font-bold">âœ… ${schulteLogs[0].duration}s (${schulteLogs[0].score})</span>`
                            : `<span class="text-zinc-700 text-xs">âŒ æœªè®­ç»ƒ</span>`}
                        </td>
                        <td class="px-6 py-6 font-bold text-white">-- å¤©</td>
                        <td class="px-6 py-6">
                            ${rewardCount > 0
                            ? `<span class="inline-flex items-center gap-1 bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-xs font-bold">
                                   <span class="text-base">ğŸ–ï¸</span> ${rewardCount}
                               </span>`
                            : `<span class="text-zinc-700 text-xs">--</span>`}
                        </td>
                        <td class="px-6 py-6">
                            <div class="flex items-center gap-2">
                                <div class="${tLogs.length > 0 ? 'success-dot' : 'fail-dot'}"></div>
                                <span class="text-xs ${tLogs.length > 0 ? 'text-green-400' : 'text-red-400'}">${tLogs.length > 0 ? 'ä¼˜ç§€' : 'æ‰é˜Ÿ'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-6 text-center">
                            <button onclick="giveReward('${t.trainee_id}', '${t.name || 'å­¦å‘˜'}')" class="text-[10px] font-black uppercase tracking-tighter text-zinc-500 border border-zinc-800 px-3 py-1 rounded hover:text-white hover:border-zinc-400 transition-all hover:bg-zinc-800/50">
                                [ è¡¨æ‰¬ä¸€æ¬¡ ]
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('today-active').innerText = activeCount;

            } catch (e) {
                console.error('Refresh failed:', e);
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-20 text-center text-red-500 font-bold">åŒæ­¥å¤±è´¥: ${e.message}</td></tr>`;
                document.getElementById('total-trainees').innerText = 'Error';
                document.getElementById('today-active').innerText = 'Error';
            }
        }

        window.onload = refreshData;
        setInterval(refreshData, 30000); // 30s auto refresh
    </script>
</body>

</html>