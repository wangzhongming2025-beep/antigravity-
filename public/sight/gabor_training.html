<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gabor Patch 视觉激活训练 - VisionGuard AI</title>
    <meta name="description" content="基于神经科学的 Gabor Patch 视觉皮层激活训练工具。通过识别不同频率与对比度的光栅图案，辅助提升大脑视觉补全能力。">
    <meta name="keywords" content="Gabor Patch, 加博斑, 视觉训练, 脑科学, 视力纠正, 弱视训练">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e4e4e7;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .glass-card {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scanner-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background: linear-gradient(90deg, transparent, #22d3ee, transparent);
            animation: scan 3s linear infinite;
            z-index: 10;
        }

        @keyframes scan {
            0% {
                top: 0%
            }

            100% {
                top: 100%
            }
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option-btn:active {
            transform: scale(0.95);
        }

        .success-flash {
            animation: success 0.5s ease-out;
        }

        @keyframes success {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }

            50% {
                box-shadow: 0 0 40px 10px rgba(16, 185, 129, 0.4);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        canvas {
            image-rendering: pixelated;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header & Level Info -->
    <header class="w-full max-w-md flex justify-between items-center mb-8">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-cyan-500 flex items-center justify-center text-black font-bold">V</div>
            <div>
                <h1 class="text-lg font-bold">Gabor 激活训练</h1>
                <p class="text-[10px] text-zinc-500 uppercase tracking-widest font-mono">Neural Training V1.2</p>
            </div>
        </div>
        <div class="text-right">
            <span class="text-xs text-zinc-500">LEVEL</span>
            <div id="level-display" class="text-2xl font-black text-cyan-400">1</div>
        </div>
    </header>

    <!-- Training Arena -->
    <main class="w-full max-w-md flex flex-col items-center">

        <!-- Canvas Container -->
        <div class="relative w-72 h-72 md:w-80 md:h-80 glass-card rounded-full p-2 mb-12 flex items-center justify-center shadow-[0_0_50px_rgba(34,211,238,0.1)] overflow-hidden"
            id="canvas-container">
            <div class="scanner-line"></div>
            <canvas id="gabor-canvas" width="256" height="256" class="rounded-full bg-grey-500"></canvas>

            <!-- Guidance Overlay -->
            <div id="status-hint"
                class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 transition-opacity pointer-events-none">
                <span id="status-text" class="text-2xl font-bold uppercase italic tracking-tighter">Correct</span>
            </div>
        </div>

        <!-- Instructions -->
        <div class="text-center mb-10 px-6">
            <p class="text-sm text-zinc-400 leading-relaxed italic">
                “观察斑点纹理的方向，选择正确的倾斜角度”
            </p>
            <p class="text-[10px] text-zinc-600 mt-2">
                由加州大学神经科学模型驱动 · 视觉皮层激活
            </p>
        </div>

        <!-- Choice Area -->
        <div class="grid grid-cols-2 gap-4 w-full px-4">
            <button onclick="checkAnswer(45)"
                class="option-btn glass-card py-6 rounded-2xl flex flex-col items-center gap-2 hover:bg-zinc-800 border-zinc-700/50">
                <div class="w-12 h-1 bg-zinc-300 rotate-45 rounded-full shadow-lg shadow-white/10"></div>
                <span class="text-xs font-bold text-zinc-500">45° 斜向</span>
            </button>
            <button onclick="checkAnswer(135)"
                class="option-btn glass-card py-6 rounded-2xl flex flex-col items-center gap-2 hover:bg-zinc-800 border-zinc-700/50">
                <div class="w-12 h-1 bg-zinc-300 -rotate-45 rounded-full shadow-lg shadow-white/10"></div>
                <span class="text-xs font-bold text-zinc-500">135° 斜向</span>
            </button>
            <button onclick="checkAnswer(90)"
                class="option-btn glass-card py-6 rounded-2xl flex flex-col items-center gap-2 hover:bg-zinc-800 border-zinc-700/50">
                <div class="w-12 h-1 bg-zinc-300 rotate-90 rounded-full shadow-lg shadow-white/10"></div>
                <span class="text-xs font-bold text-zinc-500">90° 垂直</span>
            </button>
            <button onclick="checkAnswer(0)"
                class="option-btn glass-card py-6 rounded-2xl flex flex-col items-center gap-2 hover:bg-zinc-800 border-zinc-700/50">
                <div class="w-12 h-1 bg-zinc-300 rounded-full shadow-lg shadow-white/10"></div>
                <span class="text-xs font-bold text-zinc-500">0° 水平</span>
            </button>
        </div>

        <footer class="mt-12 w-full px-6 text-center">
            <div class="flex justify-between text-[10px] text-zinc-500 mb-2 font-mono">
                <span>激活深度 (Activation Depth)</span>
                <span id="contrast-val">100%</span>
            </div>
            <div class="w-full h-1.5 bg-zinc-900 rounded-full overflow-hidden mb-8">
                <div id="progress-indicator"
                    class="h-full bg-gradient-to-r from-cyan-600 to-cyan-400 transition-all duration-500"
                    style="width: 10%"></div>
            </div>

            <button onclick="submitGaborSession()"
                class="text-xs text-zinc-600 border border-zinc-800 px-4 py-2 rounded-lg hover:text-white transition-colors">
                结束特训并上报
            </button>
        </footer>

    </main>

    <!-- Navigation Back -->
    <a href="index.html" class="fixed top-8 left-8 text-zinc-500 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6" />
        </svg>
    </a>

    <script src="auth_trainee.js"></script>
    <script>
        const canvas = document.getElementById('gabor-canvas');
        const ctx = canvas.getContext('2d');
        const SIZE = 256;

        let gameState = {
            level: 1,
            contrast: 0.8,
            freq: 0.08,
            targetAngle: 0,
            sigma: 40,
            score: 0
        };

        function drawGabor(angle, contrast, frequency, sigma) {
            const imageData = ctx.createImageData(SIZE, SIZE);
            const data = imageData.data;
            const mid = SIZE / 2;
            const radians = angle * (Math.PI / 180);

            // Optimization: Cos and Sin once
            const cosA = Math.cos(radians);
            const sinA = Math.sin(radians);

            for (let y = 0; y < SIZE; y++) {
                for (let x = 0; x < SIZE; x++) {
                    const dx = x - mid;
                    const dy = y - mid;

                    // Rotated coordinates
                    const x_rot = dx * cosA + dy * sinA;
                    const y_rot = -dx * sinA + dy * cosA;

                    // Gaussian Envelope
                    const envelope = Math.exp(-(x_rot * x_rot + y_rot * y_rot) / (2 * sigma * sigma));

                    // Sinusoidal Grating
                    const grating = Math.cos(2 * Math.PI * frequency * x_rot);

                    // Combine and scale to 0-255 (Background is middle gray 128)
                    const val = 127.5 + (127.5 * contrast * envelope * grating);

                    const idx = (y * SIZE + x) * 4;
                    data[idx] = val;     // R
                    data[idx + 1] = val; // G
                    data[idx + 2] = val; // B
                    data[idx + 3] = 255; // A
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function nextLevel() {
            const angles = [0, 45, 90, 135];
            gameState.targetAngle = angles[Math.floor(Math.random() * angles.length)];

            // Adjust parameters based on level
            // As level increases, contrast drops, frequency might change
            gameState.contrast = Math.max(0.05, 0.8 * Math.pow(0.85, gameState.level - 1));
            // Frequency slightly increases to make it harder to focus
            gameState.freq = 0.06 + (gameState.level * 0.002);

            document.getElementById('level-display').innerText = gameState.level;
            document.getElementById('contrast-val').innerText = Math.round(gameState.contrast * 100) + '%';
            document.getElementById('progress-indicator').style.width = Math.min(100, (gameState.level * 5)) + '%';

            drawGabor(gameState.targetAngle, gameState.contrast, gameState.freq, gameState.sigma);
        }

        function checkAnswer(selectedAngle) {
            const hint = document.getElementById('status-hint');
            const text = document.getElementById('status-text');
            const container = document.getElementById('canvas-container');

            if (selectedAngle === gameState.targetAngle) {
                gameState.score++;
                if (gameState.score >= 2) { // 2 correct in a row to level up
                    gameState.level++;
                    gameState.score = 0;
                }

                text.innerText = "匹配成功";
                text.className = "text-2xl font-bold uppercase italic tracking-tighter text-emerald-400";
                container.classList.add('success-flash');
                setTimeout(() => container.classList.remove('success-flash'), 500);
            } else {
                gameState.level = Math.max(1, gameState.level - 1);
                gameState.score = 0;
                text.innerText = "干扰偏差";
                text.className = "text-2xl font-bold uppercase italic tracking-tighter text-red-400";
            }

            hint.classList.remove('opacity-0');
            setTimeout(() => {
                hint.classList.add('opacity-0');
                nextLevel();
            }, 800);
        }

        // Initialize first level with Auth
        window.onload = () => {
            if (TraineeAuth.checkAuth()) {
                nextLevel();
            }
        };

        function submitGaborSession() {
            if (confirm('确定结束本次特训并上报成绩吗？')) {
                TraineeAuth.reportResult('gabor', `Level ${gameState.level}`, 0);
                setTimeout(() => location.href = 'index.html', 1000);
            }
        }
    </script>
</body>

</html>